name: GEM validation pipeline

on:
  push:
  schedule:
    - cron: "10 0 * * *"

jobs:
  setup:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/metabolicatlas/memote-docker:0.17
      volumes:
        - ${{ github.workspace }}:/project:rw
      options: --user root --workdir /project
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GL_TOKEN: ${{ secrets.GL_TOKEN }}

    steps:
      - name: Install jq
        run: apt-get update && apt-get install -y jq

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fetch list of repositories
        run: |
          git config --global --add safe.directory /__w/standard-GEM-validation/standard-GEM-validation
          python -c 'import runner; runner.matrix()'

      - name: Commit index of standard-GEMs
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_user_name: validation-bot
          commit_message: update index of standard-GEMs
          file_pattern: index.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Define job matrix from index
        id: set-matrix
        run: |
          MATRIX_JSON=$(jq -c '{include: [to_entries[] as $p | $p.value[] | {gem: ., provider: $p.key}]}' index.json)
          echo "matrix=${MATRIX_JSON}" >> "$GITHUB_OUTPUT"

  validate:
    needs: setup
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/metabolicatlas/memote-docker:0.17
      volumes:
        - ${{ github.workspace }}:/project:rw
      options: --user root --workdir /project
      env:
        GUROBI_LICENSE_B64: ${{ secrets.GUROBI_LICENSE_B64 }}
    continue-on-error: true
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GL_TOKEN: ${{ secrets.GL_TOKEN }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
      # max-parallel: 1

    steps:
      - name: Set solver to Gurobi using license secret
        run: |
          /usr/local/bin/entrypoint.sh /bin/sh -c '
            echo "COBRA_SOLVER=$COBRA_SOLVER" >> "$GITHUB_ENV"
            echo "GRB_LICENSE_FILE=$GRB_LICENSE_FILE" >> "$GITHUB_ENV"
          '
        env:
          GUROBI_LICENSE_B64: ${{ secrets.GUROBI_LICENSE_B64 }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate repository
        run: |
          git config --global --add safe.directory /__w/standard-GEM-validation/standard-GEM-validation
          python -c 'import runner; runner.validate("${{ matrix.gem }}", "${{ matrix.provider }}")'

      - name: Commit and push validation output
        run : |
          git config user.name github-actions[bot]
          git config user.email github-actions@github.com
          git pull --ff
          git add results/*.json avatars/*
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m 'update validation results for ${{ matrix.gem }}'
            if ! git push; then
              for attempt in 1 2 3; do
                git pull --rebase
                if git push; then
                  break
                fi
                if [ "$attempt" -eq 3 ]; then
                  echo "Failed to push after $attempt attempts" >&2
                  exit 1
                fi
                sleep $(( $attempt * ${{ strategy.job-index }} ))
              done
            fi
          fi
