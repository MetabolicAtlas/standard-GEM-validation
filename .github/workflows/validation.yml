name: validation

on:
  push:
  schedule:
    - cron: "0 0 * * *"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - id: set-matrix
        run: echo "::set-output name=matrix::$(python -c 'import runner; runner.matrix()')"

      - name: Cache pip directory
        uses: actions/cache@v3
        id: cache
        with:
          path: ~/.cache/pip
          key: ${{ github.sha }}

  validate:
    needs: setup
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.setup.outputs.matrix)}}
      max-parallel: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Restore pip cache directory
        uses: actions/cache@v3
        id: cache
        with:
          path: ~/.cache/pip
          key: ${{ github.sha }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Validate repository
        run: python -c 'import runner; runner.validate("${{ matrix.gem }}")'

      - name: Update branch
        run: git pull --ff

      - name: Auto-commit results
        uses: stefanzweifel/git-auto-commit-action@v4.4.0
        with:
          commit_user_name: validation-bot
          commit_message: update validation results for ${{ matrix.gem }}
          file_pattern: results/*.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
